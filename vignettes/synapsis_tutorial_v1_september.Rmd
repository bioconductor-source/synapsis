---
title: "Using synapsis"
author: "Lucy McNeill"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{synapsis_tutorial_v1}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(synapsis)
library(knitr)
library(rmarkdown)
library(tidyverse)
library(ggplot2)
```

# Getting started

## installing library from gitlab

To use synapsis, you will need the following packages:

- stats
- EBImage
- graphics
- utils

And to run this tutorial, you will need:

- tidyverse
- ggplot2
- knitr
- rmarkdown


```{r, eval = FALSE}
devtools::install_git('https://github.com/mcneilllucy/synapsis')
```

## loading synapsis

```{r}
library(EBImage)
library(synapsis)
```
## checking documentation

## Data preparation

For the moment, we will use the example images which come with synapsis.

```{r}
path = paste0(system.file("extdata",package = "synapsis"))
```

### MLH3 channel

Look at the MLH3 channel
```{r}
file_MLH3 <- paste0(path,"/MLH3rabbit488_SYCP3mouse594_fancm_fvb_x_fancm_bl6_724++_slide01_006-MLH3.tif")
image_MLH3 <- readImage(file_MLH3)
display(image_MLH3)
```


### SYCP3 channel

```{r}
file_SYCP3 <- paste0(path,"/MLH3rabbit488_SYCP3mouse594_fancm_fvb_x_fancm_bl6_724++_slide01_006-SYCP3.tif")
image_SYCP3 <- readImage(file_SYCP3)
display(image_SYCP3)
```


# Calling functions on data

## Cropping routine

You can type 
```{r,  eval = FALSE}
??auto_crop_fast
```
There is an annotation setting, which we switch to "on".  max_cell_area and  min_cell_area have been calibrated to our data set, where the subject are mouse cells and magnification kept constant. You could run it on the first five images by setting e.g. test_amount = 5. But for now we will just look at the single image.
```{r}
#source("~/Documents/svi/synapsis/R/auto_crop_fast.R")
auto_crop_fast(path, annotation = "on", max_cell_area = 30000, min_cell_area = 7000, file_ext = "tif")
```
Here we called path, plus other optional parameters (that would otherwise take on default values). But only path is essential. This is because auto_crop_fast has built-in default values which are assumed when the user doesn't specify.

A crops folder with three channels per "viable cell" should have been generated inside the folder where these images are kept i.e. in path.

Now we will see one of the useful feautres of synapsis. It can separate cells by making use of EBImage's watershed and distmap functions. If we set crowded_cells = TRUE, then 

```{r}
#source("~/Documents/svi/synapsis/R/auto_crop_fast.R")
auto_crop_fast(path, annotation = "on", max_cell_area = 30000, min_cell_area = 7000, file_ext = "tif",crowded_cells = TRUE)
```
## Getting pachytene 

```{r}
SYCP3_stats <- get_pachytene(path,ecc_thresh = 0.8, area_thresh = 0.04, annotation = "on",file_ext = "tif")
```
SYCP3_stats is a data frame summarizing some features of the cells classified as pachytene.
## Counting foci 

foci_counts is a data frame summarizing some features (including foci counts) of the cells classified as pachytene.

```{r}
#source("~/Documents/svi/synapsis/R/count_foci.R")
foci_counts <- count_foci(path,offset_factor = 8, brush_size = 5, offset_px = 0.3, brush_sigma = 5, annotation = "on",stage = "pachytene",file_ext = "tif", watershed_stop= "on",  crowded_foci = FALSE, C1 = 0.03, disc_size_foci = 9)
print(foci_counts)
```

**note: count_foci and measure_distances_general take in the same arguments used to create the coincident foci mask. To save time, find the optimum settings for e.g. offset_factor, brush_size, brush_sigma, watershed_stop etc. with count_foci (a much faster function). When you are confident that these settings are identifying the correct amount of foci per cell, run measure_distances_general (slower)**
